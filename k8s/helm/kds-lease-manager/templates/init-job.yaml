{{- if .Values.init.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "kds-lease-manager.fullname" . }}-init
  namespace: {{ .Values.namespace }}
  labels:
    {{- include "kds-lease-manager.labels" . | nindent 4 }}
    app: localstack-init
spec:
  backoffLimit: {{ .Values.init.backoffLimit }}
  ttlSecondsAfterFinished: {{ .Values.init.ttlSecondsAfterFinished }}
  template:
    metadata:
      labels:
        app: localstack-init
    spec:
      restartPolicy: OnFailure
      containers:
      - name: init
        image: "{{ .Values.init.image.repository }}:{{ .Values.init.image.tag }}"
        command:
        - /bin/bash
        - -c
        - |
          set -e
          echo "Waiting for LocalStack to be ready..."
          until curl -s http://localstack:4566/_localstack/health | grep -q "\"kinesis\": \"available\""; do
            echo "Waiting for LocalStack services..."
            sleep 5
          done
          echo "LocalStack is ready!"
          
          # Configure AWS CLI for LocalStack
          export AWS_ACCESS_KEY_ID={{ .Values.consumer.aws.accessKeyId }}
          export AWS_SECRET_ACCESS_KEY={{ .Values.consumer.aws.secretAccessKey }}
          export AWS_DEFAULT_REGION={{ .Values.consumer.aws.region }}
          
          # Create Kinesis stream
          echo "Creating Kinesis stream: {{ .Values.consumer.stream.name }} with {{ .Values.consumer.stream.initialShardCount }} shards..."
          aws kinesis create-stream \
            --stream-name {{ .Values.consumer.stream.name }} \
            --shard-count {{ .Values.consumer.stream.initialShardCount }} \
            --endpoint-url {{ .Values.consumer.aws.endpointUrl }} || echo "Stream might already exist"
          
          # Wait for stream to be active
          echo "Waiting for stream to become active..."
          for i in {1..30}; do
            STATUS=$(aws kinesis describe-stream \
              --stream-name {{ .Values.consumer.stream.name }} \
              --endpoint-url {{ .Values.consumer.aws.endpointUrl }} \
              --query 'StreamDescription.StreamStatus' \
              --output text 2>/dev/null || echo "CREATING")
            
            if [ "$STATUS" = "ACTIVE" ]; then
              echo "Stream is active!"
              break
            fi
            echo "Stream status: $STATUS, waiting..."
            sleep 2
          done
          
          # List shards to verify
          echo "Listing shards..."
          SHARD_COUNT=$(aws kinesis list-shards \
            --stream-name {{ .Values.consumer.stream.name }} \
            --endpoint-url {{ .Values.consumer.aws.endpointUrl }} \
            --query 'length(Shards)' \
            --output text)
          echo "Created stream with $SHARD_COUNT shards"
          
          # Create DynamoDB table for KCL leases
          echo "Creating DynamoDB lease table..."
          aws dynamodb create-table \
            --table-name {{ .Values.consumer.app.name }} \
            --attribute-definitions \
              AttributeName=leaseKey,AttributeType=S \
            --key-schema \
              AttributeName=leaseKey,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --endpoint-url {{ .Values.consumer.aws.endpointUrl }} || echo "Table might already exist"
          
          # Create metadata table
          echo "Creating metadata table..."
          aws dynamodb create-table \
            --table-name {{ .Values.consumer.app.name }}_meta \
            --attribute-definitions \
              AttributeName=worker_id,AttributeType=S \
            --key-schema \
              AttributeName=worker_id,KeyType=HASH \
            --billing-mode PAY_PER_REQUEST \
            --endpoint-url {{ .Values.consumer.aws.endpointUrl }} || echo "Metadata table might already exist"
          
          echo "Initialization complete!"
          
          # List all tables
          echo "DynamoDB tables:"
          aws dynamodb list-tables --endpoint-url {{ .Values.consumer.aws.endpointUrl }}
          
          echo "Setup completed successfully!"
        env:
        - name: AWS_REGION
          value: {{ .Values.consumer.aws.region | quote }}
{{- end }}


